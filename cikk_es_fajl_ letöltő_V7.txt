//
// --- "BOMBABIZTOS" CIKK-ÉS-FÁJL-LETÖLTŐ (v7) ---
//
// JAVÍTÁS: A szkript már "okos" szűrőt használ (/\d{4,}$/),
// ami megkülönbözteti a valódi cikkeket (pl. /16816)
// a "csempe oldalaktól" (pl. /page5).
// Ez a szkript már NEM fogja letölteni a "hulladékot".
//

// === KONFIGURÁCIÓ ===
// 10 másodperc a cikkek között (kíméletes)
const delayBetweenArticlesMs = 10000;
// 2 másodperc a fájlok között
const delayBetweenFilesMs = 2000;
// =====================


// --- Segédfüggvények ---
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// HTML MENTÉSE (Ez eddig is jó volt)
function saveTextAsFile(content, filename, mimeType = 'text/html;charset=utf-8') {
    console.log(`  -> HTML mentése: ${filename}`);
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// "BOMBABIZTOS" KÓD LETÖLTŐ (Indexelés garantálva)
async function triggerDownload_BOMBABIZTOS(relativeUrl, filename) {
    console.log(`  -> KÓD FÁJL letöltése (Bombabiztos mód): ${filename}`);

    // A relatív URL-t (pl. /files/kód.zip) abszolúttá alakítjuk
    const absoluteUrl = new URL(relativeUrl, window.location.href).href;

    try {
        const response = await fetch(absoluteUrl, { mode: 'cors' });
        if (!response.ok) {
            throw new Error(`HTTP hiba: ${response.status} ${response.statusText}`);
        }

        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename; // Az INDEXELT név
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        console.log(`  [OK] Indexelés sikeres: ${filename}`);

    } catch (error) {
        console.error(`    -> HIBA: ${filename} letöltése sikertelen: ${error.message}`);
        console.error(`       (URL: ${absoluteUrl})`);
    }
}

// --- Fő Szkript (v7) ---
async function startFullArticleDownloader_v7() {

    // --- 1. LÉPÉS: Cikk linkek gyűjtése (CRAWL) ---
    console.log('[1. LÉPÉS] Cikk linkek keresése ezen a "csempe oldalon"...');
    let allLinksOnPage = Array.from(document.querySelectorAll('a'));

    const articlePageUrls = [...new Set(
        allLinksOnPage
            // *** A "BETONBIZTOS" JAVÍTÁS (v7) ***
            // Csak azokat a linkeket szűrjük, amik /articles/ tartalmaznak
            // ÉS legalább 4 számjegyre végződnek (pl. /1234, /20173).
            // Ezzel KIZÁRJUK a "csempe oldalakat" (pl. /page5).
            .filter(link => link.href.includes('/articles/') && /\d{4,}$/.test(link.href))
            .map(link => link.href) // Pl. "/en/articles/16816"
    )];

    if (articlePageUrls.length === 0) {
        console.error('--- HIBA ---');
        console.error('Ezen az oldalon nem található egyetlen VALÓDI cikk link sem (pl. /articles/12345).');
        return;
    }

    console.log(`[1. LÉPÉS] OK: ${articlePageUrls.length} db VALÓDI cikk link találva (a "csempe oldalak" kiszűrve).`);
    console.warn(`FIGYELEM: A böngésző engedélyt kérhet több fájl letöltéséhez. Kérlek, engedélyezd!`);

    const parser = new DOMParser();

    // --- 2. LÉPÉS: Cikkek ÉS FÁJLOK letöltése (FETCH & SAVE) ---
    console.log(`[2. LÉPÉS] Indul ${articlePageUrls.length} db cikk és csatolmányainak letöltése...`);

    for (let i = 0; i < articlePageUrls.length; i++) {
        const relativeUrl = articlePageUrls[i];
        const urlParts = relativeUrl.split('/');
        const articleId = urlParts[urlParts.length - 1];
        const absoluteArticleUrl = new URL(relativeUrl, window.location.href).href;

        try {
            console.log(`--- [${i+1}/${articlePageUrls.length}] Cikk feldgozása: ${absoluteArticleUrl} (ID: ${articleId}) ---`);

            // 1. A VALÓDI cikk HTML tartalmának letöltése
            const response = await fetch(absoluteArticleUrl);
            if (!response.ok) throw new Error(`HTTP hiba: ${response.status}`);
            const htmlText = await response.text();

            // 2. A CIKK (HTML) MENTÉSE (Indexelve)
            const htmlFilename = `article_${articleId}.html`;
            saveTextAsFile(htmlText, htmlFilename);

            // 3. CSATOLMÁNYOK KERESÉSE a letöltött HTML-ben
            const doc = parser.parseFromString(htmlText, 'text/html');
            const attachmentLinks = Array.from(doc.querySelectorAll('a')).filter(link =>
                link.href.endsWith('.mq5') ||
                link.href.endsWith('.mqh') ||
                link.href.endsWith('.h') ||
                link.href.endsWith('.py') ||
                link.href.endsWith('.zip') ||
                link.href.endsWith('.set') ||
                link.href.endsWith('.ex5')
            );

            if (attachmentLinks.length > 0) {
                console.log(`  -> Találat: ${attachmentLinks.length} db csatolmány.`);

                // 4. CSATOLMÁNYOK MENTÉSE (Indexelve)
                for (const link of attachmentLinks) {
                    await wait(delayBetweenFilesMs);

                    const originalFilename = link.href.split('/').pop();
                    const indexedFilename = `article_${articleId}__${originalFilename}`;

                    // A "bombabiztos" funkció hívása
                    await triggerDownload_BOMBABIZTOS(link.href, indexedFilename);
                }
            } else {
                console.log("  -> Ehhez a cikkhez nem tartozik letölthető fájl.");
            }

        } catch (error) {
            console.error(`    -> HIBA: ${absoluteArticleUrl} feldgozása sikertelen: ${error.message}`);
        }

        // Késleltetés a KÖVETKEZŐ CIKK előtt
        if (i < articlePageUrls.length - 1) {
            console.log(`--- Várakozás ${delayBetweenArticlesMs / 1000} másodpercet a következő cikkig... ---`);
            await wait(delayBetweenArticlesMs);
        }
    }

    console.log('--- "BOMBABIZTOS" (v7) LETÖLTÉSI FOLYAMAT BEFEJEZVE ---');
    console.log('Ellenőrizd a letöltési mappádat.');
}

// A teljes folyamat indítása
startFullArticleDownloader_v7();
