//
// --- "BOMBABIZTOS" CIKK-ÉS-FÁJL-LETÖLTŐ (v11) ---
//
// Ez a szkript a V10-es verzió "doc is not defined" hibáját javítja.
//
// "BETONBIZTOS" JAVÍTÁS (v11):
// 1. JAVÍTVA: A hiányzó `const doc = parser.parseFromString(...)` sor
//    vissza lett téve.
// 2. SZŰRŐ: Kizárólag a kód-fájlokat keresi (nincs .doc, .pdf).
// 3. LOGIKA: Ha talál ZIP-et, CSAK az ELSŐ ZIP-et tölti le.
// 4. INDEXELÉS: Garantálja az indexelést (Fetch/Blob).
// 5. "CSEMPE" SZŰRÉS: Garantáltan kiszűri a "hulladék" csempe oldalakat.
//

// === KONFIGURÁCIÓ ===
const delayBetweenArticlesMs = 1000; // 10 másodperc (kíméletes)
const delayBetweenFilesMs = 1000;

// JAVÍTÁS (v10): "Betonbiztos" szűrő a kód-fájlokra
const CODE_EXTENSIONS = [
    '.zip',
    '.mq5',
    '.mqh',
    '.h',
    '.py',
    '.set',
    '.ex5'
];
// =====================


// --- Segédfüggvények ---
const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

function saveTextAsFile(content, filename, mimeType = 'text/html;charset=utf-8') {
    console.log(`  -> HTML mentése: ${filename}`);
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// "BOMBABIZTOS" KÓD LETÖLTŐ (Indexelés garantálva)
async function triggerDownload_BOMBABIZTOS(relativeUrl, filename) {
    console.log(`  -> KÓD FÁJL letöltése (Bombabiztos mód): ${filename}`);
    const absoluteUrl = new URL(relativeUrl, window.location.href).href;

    try {
        const response = await fetch(absoluteUrl, { mode: 'cors' });
        if (!response.ok) {
            throw new Error(`HTTP hiba: ${response.status} ${response.statusText}`);
        }

        const blob = await response.blob();
        const blobUrl = URL.createObjectURL(blob);

        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename; // Az INDEXELT név
        document.body.appendChild(a);
        a.click();

        document.body.removeChild(a);
        URL.revokeObjectURL(blobUrl);
        console.log(`  [OK] Indexelés sikeres: ${filename}`);

    } catch (error) {
        console.error(`    -> HIBA: ${filename} letöltése sikertelen: ${error.message}`);
        console.error(`       (URL: ${absoluteUrl})`);
    }
}

// --- Fő Szkript (v11) ---
async function startFullArticleDownloader_v11() {

    // --- 1. LÉPÉS: Cikk linkek gyűjtése (CRAWL) ---
    console.log('[1. LÉPÉS] Cikk linkek keresése ezen a "csempe oldalon"...');
    let allLinksOnPage = Array.from(document.querySelectorAll('a'));

    const articlePageUrls = [...new Set(
        allLinksOnPage
            // "Csempe oldalak" kiszűrése (v7 logika)
            .filter(link => link.href.includes('/articles/') && /\d{4,}$/.test(link.href))
            .map(link => link.href)
    )];

    if (articlePageUrls.length === 0) {
        console.error('--- HIBA ---');
        console.error('Ezen az oldalon nem található egyetlen VALÓDI cikk link sem (pl. /articles/12345).');
        return;
    }

    console.log(`[1. LÉPÉS] OK: ${articlePageUrls.length} db VALÓDI cikk link találva.`);
    console.warn(`FIGYELEM: A böngésző engedélyt kérhet több fájl letöltéséhez. Kérlek, engedélyezd!`);

    const parser = new DOMParser();

    // --- 2. LÉPÉS: Cikkek ÉS FÁJLOK letöltése (FETCH & SAVE) ---
    console.log(`[2. LÉPÉS] Indul ${articlePageUrls.length} db cikk és csatolmányainak letöltése...`);

    for (let i = 0; i < articlePageUrls.length; i++) {
        const relativeUrl = articlePageUrls[i];
        const urlParts = relativeUrl.split('/');
        const articleId = urlParts[urlParts.length - 1];
        const absoluteArticleUrl = new URL(relativeUrl, window.location.href).href;

        try {
            console.log(`--- [${i+1}/${articlePageUrls.length}] Cikk feldgozása: ${absoluteArticleUrl} (ID: ${articleId}) ---`);

            // 1. A VALÓDI cikk HTML tartalmának letöltése
            const response = await fetch(absoluteArticleUrl);
            if (!response.ok) throw new Error(`HTTP hiba: ${response.status}`);
            const htmlText = await response.text();

            // 2. A CIKK (HTML) MENTÉSE (Indexelve)
            const htmlFilename = `article_${articleId}.html`;
            saveTextAsFile(htmlText, htmlFilename);

            // *** JAVÍTÁS (v11): A 'doc' DEFINIÁLÁSA ***
            // Ez a sor hiányzott a v10-ből, ami a "doc is not defined" hibát okozta.
            const doc = parser.parseFromString(htmlText, 'text/html');

            // 3. CSATOLMÁNYOK KERESÉSE (JAVÍTOTT v10 SZŰRŐ)
            const allAttachmentLinks = Array.from(doc.querySelectorAll('a')).filter(link =>
                // Csak a "betonbiztos" kód-kiterjesztéseket keressük
                CODE_EXTENSIONS.some(ext => link.href.endsWith(ext))
            );

            // --- v9/v10 LOGIKA KEZDETE (A TE TERVED) ---

            const zipLinks = allAttachmentLinks.filter(link => link.href.endsWith('.zip'));
            const otherLinks = allAttachmentLinks.filter(link => !link.href.endsWith('.zip'));

            let linksToDownload = []; // Ez a "betonbiztos" lista

            let primaryDownloadZip = zipLinks.find(link =>
                link.innerText.toLowerCase().includes('download zip')
            );

            if (primaryDownloadZip) {
                // ESET 1: Van "Download ZIP". CSAK azt.
                console.log("    -> 'Download ZIP' link megtalálva. Csak ezt töltjük le.");
                console.log("    -> (Minden más .mqh, .py fájl kihagyva, mert 'benne vannak'.)");
                linksToDownload.push(primaryDownloadZip);
            } else if (zipLinks.length > 0) {
                // ESET 2: Nincs "Download ZIP", de van MÁSIK zip.
                console.log("    -> 'Download ZIP' nem található, de van másik ZIP. Csak az ELSŐ ZIP-et töltjük le.");
                console.log("    -> (Minden más .mqh, .py fájl kihagyva, mert 'benne vannak'.)");
                linksToDownload.push(zipLinks[0]);
            } else {
                // ESET 3: Egyáltalán nincs ZIP.
                console.log("    -> ZIP fájl nem található. Az összes különálló fájl (.mqh, .py) letöltése.");
                linksToDownload = otherLinks;
            }

            // --- v11 JAVÍTÁS VÉGE ---

            if (linksToDownload.length > 0) {
                console.log(`  -> Találat (szűrés után): ${linksToDownload.length} db csatolmány kerül letöltésre.`);

                // 4. CSATOLMÁNYOK MENTÉSE (Indexelve)
                for (const link of linksToDownload) {
                    await wait(delayBetweenFilesMs);

                    const originalFilename = link.href.split('/').pop();
                    const indexedFilename = `article_${articleId}__${originalFilename}`;

                    // A "bombabiztos" funkció hívása
                    await triggerDownload_BOMBABIZTOS(link.href, indexedFilename);
                }
            } else {
                console.log("  -> Ehhez a cikkhez nem tartozik letölthető fájl.");
            }

        } catch (error) {
            console.error(`    -> HIBA: ${absoluteArticleUrl} feldgozása sikertelen: ${error.message}`);
        }

        // Késleltetés a KÖVETKEZŐ CIKK előtt
        if (i < articlePageUrls.length - 1) {
            console.log(`--- Várakozás ${delayBetweenArticlesMs / 1000} másodpercet a következő cikkig... ---`);
            await wait(delayBetweenArticlesMs);
        }
    }

    console.log('--- "BOMBABIZTOS" (v11) LETÖLTÉSI FOLYAMAT BEFEJEZVE ---');
    console.log('Ellenőrizd a letöltési mappádat.');
}

// A teljes folyamat indítása
startFullArticleDownloader_v11();
