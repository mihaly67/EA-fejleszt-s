# --- 1. LÃ‰PÃ‰S: GIT RESET (Ã“VATOSAN) ---
# Csak a kÃ¶rnyezetet tisztÃ­tjuk, de a lokÃ¡lis fÃ¡jljaidat bÃ©kÃ©n hagyjuk.
git update-index --assume-unchanged kutato.py > /dev/null 2>&1

# --- 2. LÃ‰PÃ‰S: NÃ‰MA TELEPÃTÃ‰S ---
echo "â³ KÃ¶rnyezet Ã©s fÃ¼ggÅ‘sÃ©gek ellenÅ‘rzÃ©se..."
pip install -q gdown sentence-transformers faiss-cpu numpy

# --- 3. LÃ‰PÃ‰S: AUTOMATA RENDSZERÃ‰PÃTÅ (LetÃ¶ltÃ©s + EszkÃ¶z GenerÃ¡lÃ¡s) ---
python3 -c "
import os, gdown, zipfile, shutil, warnings, logging, sqlite3, sys

# NÃ‰MA ÃœZEMMÃ“D
warnings.filterwarnings('ignore')
logging.getLogger('sentence_transformers').setLevel(logging.ERROR)

# --- KONFIGURÃCIÃ“ ---
DATABASES = {
    'THEORY_RAG':   {'link': os.environ.get('THEORY_RAG_LINK'),   'zip': 'THEORY_RAG.zip',   'dir': 'rag_theory'},
    'CODEBASE_RAG': {'link': os.environ.get('CODEBASE_RAG_LINK'), 'zip': 'CODEBASE_RAG.zip', 'dir': 'rag_code'},
    'MQL5_DEV_RAG': {'link': os.environ.get('MQL5_DEV_RAG_LINK'), 'zip': 'MQL5_DEV_RAG.zip', 'dir': 'rag_mql5_big'}
}

print('\nâ¬‡ï¸  RAG ADATBÃZISOK SZINKRONIZÃLÃSA...')

for key, config in DATABASES.items():
    if not config['link']:
        # Ha nincs link, csendben lÃ©pÃ¼nk tovÃ¡bb (nem szemeteljÃ¼k a logot)
        continue

    # EllenÅ‘rizzÃ¼k, hogy megvan-e mÃ¡r a mappa Ã©s nem Ã¼res-e
    if os.path.exists(config['dir']) and os.listdir(config['dir']):
        print(f'   âœ… {key}: MÃ¡r telepÃ­tve. (KihagyÃ¡s)')
        continue

    try:
        print(f'   ğŸ“¥ LetÃ¶ltÃ©s: {key} ...')
        gdown.download(config['link'], config['zip'], quiet=True, fuzzy=True)
        
        if os.path.exists(config['dir']): shutil.rmtree(config['dir'])
        os.makedirs(config['dir'], exist_ok=True)
        
        with zipfile.ZipFile(config['zip'], 'r') as z:
            z.extractall(config['dir'])
        
        if os.path.exists(config['zip']): os.remove(config['zip'])
        print(f'   âœ¨ {key} KÃ‰SZ.')
    except Exception as e:
        print(f'   âŒ HIBA ({key}): {e}')

# --- KUTATO.PY KEZELÃ‰SE (OKOS MÃ“D) ---
# Csak akkor Ã­rjuk felÃ¼l, ha nem lÃ©tezik! Ãgy szabadon fejleszthetÅ‘.
if not os.path.exists('kutato.py'):
    print('\nğŸ› ï¸  kutato.py lÃ©trehozÃ¡sa (Mert mÃ©g nem lÃ©tezett)...')
    code = r'''#!/usr/bin/env python
import sys, sqlite3, faiss, numpy as np, os, argparse, glob, warnings, logging
from sentence_transformers import SentenceTransformer

warnings.filterwarnings('ignore')
os.environ['TOKENIZERS_PARALLELISM'] = 'false'
logging.getLogger('sentence_transformers').setLevel(logging.ERROR)

MODELS = {
    'high_dim': {'name': 'all-mpnet-base-v2', 'dim': 768, 'instance': None},
    'low_dim':  {'name': 'all-MiniLM-L6-v2',  'dim': 384, 'instance': None}
}

KB_CONFIG = [
    {'id': 'THEORY',   'path': 'rag_theory',   'model_type': 'high_dim', 'desc': 'ElmÃ©let'},
    {'id': 'CODE',     'path': 'rag_code',     'model_type': 'high_dim', 'desc': 'KÃ³d'},
    {'id': 'MQL5_BIG', 'path': 'rag_mql5_big', 'model_type': 'low_dim',  'desc': 'DokumentÃ¡ciÃ³'}
]

def get_model(m_type):
    if MODELS[m_type]['instance'] is None:
        MODELS[m_type]['instance'] = SentenceTransformer(MODELS[m_type]['name'])
    return MODELS[m_type]['instance']

def find_db_files(directory):
    if not os.path.exists(directory): return None, None
    dbs = glob.glob(os.path.join(directory, '*.db'))
    idxs = glob.glob(os.path.join(directory, '*.index'))
    return (dbs[0], idxs[0]) if dbs and idxs else (None, None)

def search_kb(kb, query, top_k=4):
    db, idx_path = find_db_files(kb['path'])
    if not db: return []
    try:
        model = get_model(kb['model_type'])
        q_vec = model.encode([query])
        index = faiss.read_index(idx_path, faiss.IO_FLAG_MMAP)
        if index.d != q_vec.shape[1]: return []
        
        D, I = index.search(q_vec, k=top_k)
        
        conn = sqlite3.connect(db)
        cursor = conn.cursor()
        res = []
        for r, i in enumerate(I[0]):
            if i == -1: continue
            cursor.execute('SELECT filename, content, code FROM articles WHERE id=?', (int(i),))
            row = cursor.fetchone()
            if row:
                res.append({'src': kb['id'], 'file': row[0], 'txt': (row[2] if len(row[2])>50 else row[1])[:1000], 'sc': float(D[0][r])})
        conn.close()
        return res
    except: return []

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument('action', choices=['search'])
    parser.add_argument('query', nargs='+')
    args = parser.parse_args()
    q = ' '.join(args.query)

    print(f'ğŸ” KeresÃ©s: {q} ...')
    all_res = []
    for kb in KB_CONFIG:
        if os.path.exists(kb['path']):
            all_res.extend(search_kb(kb, q))
    
    if not all_res: print('âŒ Nincs talÃ¡lat.'); return

    for kb in KB_CONFIG:
        hits = sorted([r for r in all_res if r['src'] == kb['id']], key=lambda x: x['sc'])
        if hits:
            print(f'\nğŸ“ {kb['id']} ({kb['desc']}):')
            for h in hits:
                print(f'   ğŸ“„ {h['file']}')
                print(f'      {h['txt'][:120].replace(chr(10), ' ')}...')
                print('-' * 30)

if __name__ == '__main__':
    main()
'''
    with open('kutato.py', 'w', encoding='utf-8') as f:
        f.write(code)
    print('   âœ… kutato.py lÃ©trehozva.')
else:
    print('\nğŸ›¡ï¸  kutato.py mÃ¡r lÃ©tezik -> NEM Ã­rtam felÃ¼l. (TestreszabÃ¡s megÅ‘rizve)')

print('\nğŸš€ RENDSZER KÃ‰SZ. A RAG adatbÃ¡zisok a helyÃ¼kÃ¶n.')
"

# --- 4. LÃ‰PÃ‰S: GIT IGNORÃLÃS ---
# Hogy ne zavarjon be a stÃ¡tuszba
for d in rag_theory rag_code rag_mql5_big; do echo "$d" >> .git/info/exclude; done
git update-index --assume-unchanged kutato.py > /dev/null 2>&1



# --- 5. LÃ‰PÃ‰S: AZONNALI SANITY CHECK ---
echo "ğŸ§ª Automatikus rendszerellenÅ‘rzÃ©s indÃ­tÃ¡sa..."
if [ -f "kutato.py" ]; then
    python3 kutato.py search "MACD"
else
    echo "âŒ Hiba: A kutato.py nem jÃ¶tt lÃ©tre."
fi
