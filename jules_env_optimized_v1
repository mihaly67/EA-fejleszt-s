# --- 1. LÃ‰PÃ‰S: GIT RESET (Ã“VATOSAN) ---
git update-index --assume-unchanged kutato.py > /dev/null 2>&1

# --- 2. LÃ‰PÃ‰S: NÃ‰MA TELEPÃTÃ‰S ---
echo "â³ KÃ¶rnyezet Ã©s fÃ¼ggÅ‘sÃ©gek ellenÅ‘rzÃ©se..."
pip install -q gdown sentence-transformers faiss-cpu numpy

# --- 3. LÃ‰PÃ‰S: AUTOMATA RENDSZERÃ‰PÃTÅ ---
python3 -c "
import os, gdown, zipfile, shutil, warnings, logging, sqlite3, sys

# NÃ‰MA ÃœZEMMÃ“D
warnings.filterwarnings('ignore')
logging.getLogger('sentence_transformers').setLevel(logging.ERROR)

# LINK DEFINÃCIÃ“K
LINKS = {
    'THEORY': 'https://drive.google.com/file/d/1T0etzQc1bdT89X67sa3zMbuZNZWM-Anv/view?usp=sharing',
    'CODE':   'https://drive.google.com/file/d/1CmoE49YTc_-dxyn4EiYyIDHINENeT5KI/view?usp=drive_link',
    'MQL5':   'https://drive.google.com/file/d/1gMumIUSdXuUlHJuymbWE8GwAd5K7ruSy/view?usp=sharing'
}

# --- KONFIGURÃCIÃ“ ---
# MQL5: Disk-Only (MMAP), Theory/Code: Memory-Loaded
DATABASES = {
    'THEORY_RAG':   {'link': LINKS['THEORY'], 'zip': 'THEORY_RAG.zip',   'dir': 'rag_theory',   'mode': 'MEMORY'},
    'CODEBASE_RAG': {'link': LINKS['CODE'],   'zip': 'CODEBASE_RAG.zip',   'dir': 'rag_code',     'mode': 'MEMORY'},
    'MQL5_DEV_RAG': {'link': LINKS['MQL5'],   'zip': 'MQL5_DEV_RAG.zip',   'dir': 'rag_mql5',     'mode': 'DISK'}
}

print('\nâ¬‡ï¸  RAG ADATBÃZISOK SZINKRONIZÃLÃSA...')

def search_and_hoist(target_dir):
    # MegkeressÃ¼k hol van a .db fÃ¡jl Ã©s felhozzuk a gyÃ¶kÃ©rbe
    db_file = None
    for root, dirs, files in os.walk(target_dir):
        for f in files:
            if f.endswith('.db'):
                db_file = os.path.join(root, f)
                break
        if db_file: break

    if db_file:
        source_dir = os.path.dirname(db_file)
        if source_dir != target_dir:
            # Minden fÃ¡jlt felmozgatunk
            for item in os.listdir(source_dir):
                shutil.move(os.path.join(source_dir, item), target_dir)
            # Ãœres mappÃ¡k tÃ¶rlÃ©se
            # shutil.rmtree(source_dir) # Ã“vatosan, lehet hogy nem Ã¼res a szÃ¼lÅ‘

for key, config in DATABASES.items():
    if os.path.exists(config['dir']) and os.listdir(config['dir']):
        print(f'   âœ… {key}: MÃ¡r telepÃ­tve. (KihagyÃ¡s)')
        continue

    try:
        print(f'   ðŸ“¥ LetÃ¶ltÃ©s: {key} ...')
        # Google Drive link konverziÃ³ (ID kinyerÃ©s)
        file_id = config['link'].split('/d/')[1].split('/')[0]
        gdown.download(id=file_id, output=config['zip'], quiet=True, fuzzy=True)

        if os.path.exists(config['dir']): shutil.rmtree(config['dir'])
        os.makedirs(config['dir'], exist_ok=True)

        print(f'   ðŸ“¦ KicsomagolÃ¡s: {key} ...')
        with zipfile.ZipFile(config['zip'], 'r') as z:
            z.extractall(config['dir'])

        # Hoist Logic (Mert a zipben lehet egy almappa)
        search_and_hoist(config['dir'])

        if os.path.exists(config['zip']): os.remove(config['zip'])
        print(f'   âœ¨ {key} KÃ‰SZ.')
    except Exception as e:
        print(f'   âŒ HIBA ({key}): {e}')

print('\nðŸš€ RENDSZER KÃ‰SZ. A RAG adatbÃ¡zisok a helyÃ¼kÃ¶n.')
"

# --- 4. LÃ‰PÃ‰S: GIT IGNORÃLÃS ---
for d in rag_theory rag_code rag_mql5; do echo "$d" >> .git/info/exclude; done
